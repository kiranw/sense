<!-- <!DOCTYPE html> -->
<html>
<head>
	<meta charset='utf-8'/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Sense | Integrated Emotion Detection </title>
	<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'/>
	<link rel='stylesheet' href='css/style.css'/>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700" rel="stylesheet">
	

	<script>
		// getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
		if (window.location.protocol == "file:") {
			alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
		} else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
			window.location.protocol = "https";
		}
	</script>
		
</head>
<body>

	<script src="js/utils.js"></script>
	<script src="js/clmtrackr.js"></script>
	<script src="models/model_pca_20_svm_emotionDetection.js"></script>
	<script src="js/Stats.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/emotion_classifier.js"></script>
	<script src="js/emotionmodel.js"></script>


<div id="leftpanel">
	<div class="title">Sense - 6.835 Final Project</div>
	<div class="contentText">
		<p>Lorem Khaled Ipsum is a major key to success. Look at the sunset, life is amazing, life is beautiful, life is what you make it. Cloth talk. Another one. Let me be clear, you have to make it through the jungle to make it to paradise, that’s the key, Lion! They don’t want us to eat. Watch your back, but more importantly when you get out the shower, dry your back, it’s a cold world out there. I told you all this before, when you have a swimming pool, do not use chlorine, use salt water, the healing, salt water is the healing. How’s business? Boomin.</p>

		<p>Let’s see what Chef Dee got that they don’t want us to eat. The first of the month is coming, we have to get money, we have no choice. It cost money to eat and they don’t want you to eat. The key to success is to keep your head above the water, never give up. Stay focused. They will try to close the door on you, just open it. Eliptical talk. The other day the grass was brown, now it’s green because I ain’t give up. Never surrender.</p>
	</div>
</div>

<div id="rightpanel">

	<img src="img/logo.png" class="logo" />

	<div id="content">
		<div id="controls">
			<input class="btn" type="button" value="wait, loading video" disabled="disabled" onclick="startVideo()" id="startbutton"></input>
		</div>
		<br>
		<img id="emoji" src="img/happy.png" />
		<br>

		<div class="emotion">	
			You're feeling <span class="emotionvalue">happy</span>.<br>
		</div>




		<div class="emotionScores">
		Happy: <span class="happyvalue">0.5</span><br>
		Sad: <span class="sadvalue">0.5</span><br>
		Surprised: <span class="surprisedvalue">0.5</span><br>
		Angry: <span class="angryvalue">0.5</span><br>
		</div>

		<div id="container">
			<video id="videoel" width="400" height="300" preload="auto" loop>
			</video>
			<canvas id="overlay" width="400" height="300"></canvas>
		</div>
	</div>
</div>





	
	


	<script>
		var vid = document.getElementById('videoel');
		// var overlay = document.getElementById('overlay');
		// var overlayCC = overlay.getContext('2d');
		
		/********** check and set up video/webcam **********/

		function enablestart() {
			var startbutton = document.getElementById('startbutton');
			startbutton.value = "start";
			startbutton.disabled = null;
		}
		
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
		window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

		// check for camerasupport
		if (navigator.getUserMedia) {
			// set up stream
			
			var videoSelector = {video : true};
			if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
				var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
				if (chromeVersion < 20) {
					videoSelector = "video";
				}
			};
		
			navigator.getUserMedia(videoSelector, function( stream ) {
				if (vid.mozCaptureStream) {
					vid.mozSrcObject = stream;
				} else {
					vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
				}
				vid.play();
			}, function() {
				//insertAltVideo(vid);
				alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.");
			});
		} else {
			//insertAltVideo(vid);
			alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
		}

		vid.addEventListener('canplay', enablestart, false);
		
		/*********** setup of emotion detection *************/

		var ctrack = new clm.tracker({useWebGL : true});
		ctrack.init(pModel);

		function startVideo() {
			// start video
			vid.play();
			// start tracking
			ctrack.start(vid);
			// start loop to draw face
			drawLoop();
		}
		
		initial = [0,0,0,0]

		var state = 1;

		function drawLoop() {
			requestAnimFrame(drawLoop);
			var cp = ctrack.getCurrentParameters();
			var er = ec.meanPredict(cp);
			if (er) {
				maxEmotion = "happy";
				maxValue = 0;
				for (var i = 0;i < er.length;i++) {
					if (state==1){
						initial[i] = er[i].value;
					}
					if (  (maxValue < (er[i].value-initial[i])/initial[i]) || er[i].value > 0.4 ){
						maxEmotion = er[i].emotion;
					}
					console.log(er[i]);
					$("." + er[i].emotion + "value").text(er[i].value);
				}
				console.log(maxEmotion)
				state = 0;
				$(".emotionvalue").text(maxEmotion);
				document.getElementById("emoji").src = "img/" + maxEmotion + ".png";
			}
		}
		
		var ec = new emotionClassifier();
		ec.init(emotionModel);
		var emotionData = ec.getBlank();			
	</script>


</body>
</html>