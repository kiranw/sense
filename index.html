<!-- <!DOCTYPE html> -->
<html>
<head>
	<meta charset='utf-8'/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Sense | Integrated Emotion Detection </title>
	<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'/>
	<link rel='stylesheet' href='css/style.css'/>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700" rel="stylesheet">
	

	<script>
		// getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
		if (window.location.protocol == "file:") {
			alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
		} else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
			window.location.protocol = "https";
		}
	</script>
		
</head>
<body>

	<script src="js/utils.js"></script>
	<script src="js/clmtrackr.js"></script>
	<script src="models/model_pca_20_svm_emotionDetection.js"></script>
	<script src="js/Stats.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/emotion_classifier.js"></script>
	<script src="js/emotionmodel.js"></script>

	<script src="js/webgazer.js" type="text/javascript"></script>


<div id="leftpanel">
	<!-- Collects the emojis that we annotate a page with -->
	<div id="emojiAnnotations"></div>

	<div class="title">Sense, automated localized emotion tagging for web content</div>
	<div class="contentText">
		<p>Lorem Khaled Ipsum is a major key to success. Look at the sunset, life is amazing, life is beautiful, life is what you make it. Cloth talk. Another one. Let me be clear, you have to make it through the jungle to make it to paradise, that’s the key, Lion! They don’t want us to eat. Watch your back, but more importantly when you get out the shower, dry your back, it’s a cold world out there. I told you all this before, when you have a swimming pool, do not use chlorine, use salt water, the healing, salt water is the healing. How’s business? Boomin.</p>

		<p>Let’s see what Chef Dee got that they don’t want us to eat. The first of the month is coming, we have to get money, we have no choice. It cost money to eat and they don’t want you to eat. The key to success is to keep your head above the water, never give up. Stay focused. They will try to close the door on you, just open it. Eliptical talk. The other day the grass was brown, now it’s green because I ain’t give up. Never surrender.</p>
		Don’t ever play yourself. Life is what you make it, so let’s make it. Special cloth alert. Eliptical talk. The ladies always say Khaled you smell good, I use no cologne. Cocoa butter is the key. To be successful you’ve got to work hard, to make history, simple, you’ve got to make it. Bless up. Cloth talk. Hammock talk come soon. They will try to close the door on you, just open it. It’s important to use cocoa butter. It’s the key to more success, why not live smooth? Why live rough?

		<img class="emotionalContent" src="emotionalMaterial/image1.jpg" />

		<p>Major key, don’t fall for the trap, stay focused. It’s the ones closest to you that want to see you fail. Fan luv. How’s business? Boomin. They don’t want us to win. Lion! You should never complain, complaining is a weak emotion, you got life, we breathing, we blessed. You see the hedges, how I got it shaped up? It’s important to shape up your hedges, it’s like getting a haircut, stay fresh. To succeed you must believe. When you believe, you will succeed.</p>

		<img class="emotionalContent" src="emotionalMaterial/image2.jpg" />

		<p>Egg whites, turkey sausage, wheat toast, water. Of course they don’t want us to eat our breakfast, so we are going to enjoy our breakfast. Life is what you make it, so let’s make it. The key is to enjoy life, because they don’t want you to enjoy life. I promise you, they don’t want you to jetski, they don’t want you to smile. The key is to enjoy life, because they don’t want you to enjoy life. I promise you, they don’t want you to jetski, they don’t want you to smile. In life there will be road blocks but we will over come it.</p>

		<img class="emotionalContent" src="emotionalMaterial/image3.jpg" />

		<p>Egg whites, turkey sausage, wheat toast, water. Of course they don’t want us to eat our breakfast, so we are going to enjoy our breakfast. It’s important to use cocoa butter. It’s the key to more success, why not live smooth? Why live rough? Let me be clear, you have to make it through the jungle to make it to paradise, that’s the key, Lion! Look at the sunset, life is amazing, life is beautiful, life is what you make it. Celebrate success right, the only way, apple. The key is to enjoy life, because they don’t want you to enjoy life. I promise you, they don’t want you to jetski, they don’t want you to smile.</p>

		<img class="emotionalContent" src="emotionalMaterial/image4.png" />

		<p>The key to more success is to get a massage once a week, very important, major key, cloth talk. They don’t want us to win. The ladies always say Khaled you smell good, I use no cologne. Cocoa butter is the key. It’s important to use cocoa butter. It’s the key to more success, why not live smooth? Why live rough? A major key, never panic. Don’t panic, when it gets crazy and rough, don’t panic, stay calm. The key is to enjoy life, because they don’t want you to enjoy life. I promise you, they don’t want you to jetski, they don’t want you to smile.</p>

		<img class="emotionalContent" src="emotionalMaterial/image5.jpg" />

		<p>The first of the month is coming, we have to get money, we have no choice. It cost money to eat and they don’t want you to eat. I told you all this before, when you have a swimming pool, do not use chlorine, use salt water, the healing, salt water is the healing. You see the hedges, how I got it shaped up? It’s important to shape up your hedges, it’s like getting a haircut, stay fresh. We the best. You should never complain, complaining is a weak emotion, you got life, we breathing, we blessed.</p>

		<img class="emotionalContent" src="emotionalMaterial/image6.jpg" />

		<p>Look at the sunset, life is amazing, life is beautiful, life is what you make it. I told you all this before, when you have a swimming pool, do not use chlorine, use salt water, the healing, salt water is the healing. You see that bamboo behind me though, you see that bamboo? Ain’t nothin’ like bamboo. Bless up. You see the hedges, how I got it shaped up? It’s important to shape up your hedges, it’s like getting a haircut, stay fresh. Stay focused.</p>

		<img class="emotionalContent" src="emotionalMaterial/image7.jpg" />

		<p>The key is to enjoy life, because they don’t want you to enjoy life. I promise you, they don’t want you to jetski, they don’t want you to smile. Special cloth alert. You do know, you do know that they don’t want you to have lunch. I’m keeping it real with you, so what you going do is have lunch. Every chance I get, I water the plants, Lion! Another one. You do know, you do know that they don’t want you to have lunch. I’m keeping it real with you, so what you going do is have lunch. You should never complain, complaining is a weak emotion, you got life, we breathing, we blessed.</p>

		<img class="emotionalContent" src="emotionalMaterial/image8.jpg" />

		<p>I’m giving you cloth talk, cloth. Special cloth alert, cut from a special cloth. In life you have to take the trash out, if you have trash in your life, take it out, throw it away, get rid of it, major key. Watch your back, but more importantly when you get out the shower, dry your back, it’s a cold world out there. How’s business? Boomin. Don’t ever play yourself. It’s on you how you want to live your life. Everyone has a choice. I pick my choice, squeaky clean.</p>

		<img class="emotionalContent" src="emotionalMaterial/image9.jpg" />

		<p>Congratulations, you played yourself. I’m giving you cloth talk, cloth. Special cloth alert, cut from a special cloth. Bless up. It’s important to use cocoa butter. It’s the key to more success, why not live smooth? Why live rough? Cloth talk. They don’t want us to eat. Don’t ever play yourself. Hammock talk come soon. They will try to close the door on you, just open it. You see that bamboo behind me though, you see that bamboo? Ain’t nothin’ like bamboo. Bless up. Put it this way, it took me twenty five years to get these plants, twenty five years of blood sweat and tears, and I’m never giving up, I’m just getting started.</p>
	</div>
</div>

<div id="rightpanel">

	<img src="img/logo.png" class="logo" />

	<div id="content">
		<div id="controls">
			<input class="btn" type="button" value="wait, loading video" disabled="disabled" onclick="startVideo()" id="startbutton"></input>
		</div>
		<br>
		<img id="emoji" src="img/neutral.png" />
		<br>

		<div class="emotion">	
			You're feeling <span class="emotionvalue">happy</span>.<br>
		</div>




		<div class="emotionScores">
		Happy: <span class="happyvalue">0.5</span><br>
		Sad: <span class="sadvalue">0.5</span><br>
		Surprised: <span class="surprisedvalue">0.5</span><br>
		Angry: <span class="angryvalue">0.5</span><br>
		</div>

		<div id="container">
			<video id="videoel" width="400" height="300" preload="auto" loop>
			</video>
			<canvas id="overlay" width="400" height="300"></canvas>
		</div>
	</div>
</div>


<!-- Shows where the smoothed gaze position is -->
<div id="eyePosPrediction"></div>




	




		<script>	

		//===========================================================================
		//===========================================================================
		//                        g a z e  t r a c k i n g
		//===========================================================================
		//===========================================================================

		var WINDOW_SIZE = 20;
		var gazeX = Array(WINDOW_SIZE).fill(0);
		var gazeY = Array(WINDOW_SIZE).fill(0);
		var currentX = 20;
		var currentY = 20;

		var lastPlottedX = -500;
		var lastPlottedY = -500;
		var lastEmotion = 0;


		// Takes in the coordinates from WebGazer, adjusts them to be relative to viewports
		// and screen position, and then add our value to the smoothing protocol
		function updateGazePoints(x, y) {

			// Collect the scroll position because gaze tracking only gives us relative information based
			// on what is displayed on the page window
			// reference: http://stackoverflow.com/questions/3464876/javascript-get-window-x-y-position-for-scroll
			var topScrollOffset  = $("#leftpanel").scrollTop();
		    // var leftScrollOffset = window.pageXOffset || document.documentElement.scrollLeft;
		    var leftScrollOffset = 0;

			var xpred = x + leftScrollOffset; //these x coordinates are relative to the viewport 
		    var ypred = y + topScrollOffset; //these y coordinates are relative to the viewport

		    gazeX.pop();
		    gazeY.pop();
		    gazeX.unshift(xpred);
		    gazeY.unshift(ypred);

		    // average over the window to reduce noise, can apply a weighting function to it
			currentX = gazeX.reduce( (prev, curr) => prev + curr )/(WINDOW_SIZE);
			currentY = gazeY.reduce( (prev, curr) => prev + curr )/(WINDOW_SIZE);

			// display the results
		    // console.log(currentX, currentY);
			
		    $('#eyePosPrediction').css({
			    transform: 'translate3d(' + xpred + 'px,' + ypred + 'px,0)'
			})
		}

		// Register an emotion when triggered 
		function registerEmotion(emotion) {
			console.log("attempting to register emotion")
			// prevent emotions from registering too often
			if (Math.abs(lastPlottedX - currentX) > 100 || Math.abs(lastPlottedY - currentY) > 100) {
				// prevent redundant emotions, only plot on transitions
				if (lastEmotion != emotion) {
					console.log("plotting emotion")
					$("#emojiAnnotations").append("<img src='img/" + emotion +
												 "_emoji.png' style='" + 
												 "transform:translate3d(" + currentX + 
												 "px," + currentY + "px,0)" + 
												 "' class='emoji'></div>")	
					lastPlottedX = currentX;
					lastPlottedY = currentY;
					lastEmotion  = emotion;
				}
			}
			
		}


		// Set regression model used in tracking
		webgazer.setRegression('weightedRidge');

		// Collect prediction values
		webgazer.setGazeListener(function(data, elapsedTime) {
		    if (data == null) {
		        return;
		    }

		    // Bound prediction by viewport edges
		    webgazer.util.bound(data);
		    var xprediction = data.x; // These x coordinates are relative to the viewport 
		    var yprediction = data.y; // These y coordinates are relative to the viewport

		    // Add to window for smoothing
		    updateGazePoints(xprediction, yprediction);
		    
		}).begin()
		.showPredictionPoints(true);
		           







		//===========================================================================
		//===========================================================================
		//            e m o t i o n    r e c o g n i t i o n 
		//===========================================================================
		//===========================================================================

		var vid = document.getElementById('videoel');
		// var overlay = document.getElementById('overlay');
		// var overlayCC = overlay.getContext('2d');
		
		/********** check and set up video/webcam **********/

		function enablestart() {
			var startbutton = document.getElementById('startbutton');
			startbutton.value = "start";
			startbutton.disabled = null;
		}
		
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
		window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

		// check for camerasupport
		if (navigator.getUserMedia) {
			// set up stream
			
			var videoSelector = {video : true};
			if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
				var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
				if (chromeVersion < 20) {
					videoSelector = "video";
				}
			};
		
			navigator.getUserMedia(videoSelector, function( stream ) {
				if (vid.mozCaptureStream) {
					vid.mozSrcObject = stream;
				} else {
					vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
				}
				vid.play();
			}, function() {
				//insertAltVideo(vid);
				alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.");
			});
		} else {
			//insertAltVideo(vid);
			alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
		}

		vid.addEventListener('canplay', enablestart, false);
		
		/*********** setup of emotion detection *************/

		var ctrack2 = new clm.tracker({useWebGL : true});
		ctrack2.init(pModel);

		function startVideo() {
			// start video
			vid.play();
			// start tracking
			ctrack2.start(vid);
			// start loop to draw face
			drawLoop();
		}
		
		initial = [0,0,0,0]
		initial_window = 0
		INITIAL_WINDOW_SIZE = 1

		function drawLoop() {
			requestAnimFrame(drawLoop);
			var cp = ctrack2.getCurrentParameters();
			var er = ec.meanPredict(cp);
			if (er) {
				// Generate a baseline average so that 
				// Calibration sequence
				if (initial_window < INITIAL_WINDOW_SIZE){
					for (var i = 0;i < er.length;i++) {
						initial[i] += er[i].value/INITIAL_WINDOW_SIZE;
						initial_window += 1;
					}
				}
				// Actually find the emotion that is being recorded
				else {
					maxEmotion = "neutral";
					sad = 0;
					happy = 0;
					angry = 0;
					surprised = 0;

					maxValue = 0;
					for (var i = 0;i < er.length;i++) {
						// if (  (maxValue < (er[i].value-initial[i])/initial[i]) || er[i].value > 0.6 ){
						if ( maxValue < er[i].value ){
							maxEmotion = er[i].emotion;
							maxValue = er[i].value;
						}

						if (er[i].emotion == "happy"){
							// happy = Math.max((er[i].value - initial[i])/er[i].value, er[i].value);
							happy = er[i].value * 4;
						}

						if (er[i].emotion == "sad"){
							sad = er[i].value;
							// sad =  Math.max((er[i].value - initial[i])/er[i].value, er[i].value);
						}

						if (er[i].emotion == "angry"){
							angry  = er[i].value;
							// =  Math.max((er[i].value - initial[i])/er[i].value, er[i].value);
						}

						if (er[i].emotion == "surprised"){
							surprised = er[i].value;
							 // =  Math.max((er[i].value - initial[i])/er[i].value, er[i].value);
						}

						$("." + er[i].emotion + "value").text(Math.round(er[i].value * 1000) / 1000);
					}
					console.log(maxEmotion)
					
					// make this the default emotion that is displayed
					maxEmotion = "neutral"

					// a threshold cascade to see if the emotion is extreme enough to
					// characterize with certainty, and then display
					if (maxValue > 0.5) {
						registerEmotion(maxEmotion);
						$(".emotionvalue").text(maxEmotion);
						document.getElementById("emoji").src = "img/" + maxEmotion + ".png";
					}
					// if (happy > 0.5) {
					// 	maxEmotion = "happy";
					// 	registerEmotion(maxEmotion);
					// 	$(".emotionvalue").text(maxEmotion);
					// 	document.getElementById("emoji").src = "img/" + maxEmotion + ".png";
					// }
					// else if (sad > 0.3){
					// 	if (angry > 0.4){
					// 		maxEmotion = "angry";
					// 		registerEmotion(maxEmotion);
					// 		$(".emotionvalue").text(maxEmotion);
					// 		document.getElementById("emoji").src = "img/" + maxEmotion + ".png";
					// 	}
					// 	else {
					// 		maxEmotion = "sad";
					// 		registerEmotion(maxEmotion);
					// 		$(".emotionvalue").text(maxEmotion);
					// 		document.getElementById("emoji").src = "img/" + maxEmotion + ".png";
					// 	}
					// }
					// else if (surprised > 0.4){
					// 	maxEmotion = "surprised";
					// 	registerEmotion(maxEmotion);
					// 	$(".emotionvalue").text(maxEmotion);
					// 	document.getElementById("emoji").src = "img/" + maxEmotion + ".png";
					// }

					// Neutral
					else {
						$(".emotionvalue").text("neutral");
						document.getElementById("emoji").src = "img/neutral.png";
					}
				}
			}
		}
		
		var ec = new emotionClassifier();
		ec.init(emotionModel);
		var emotionData = ec.getBlank();			
	</script>


</body>
</html>